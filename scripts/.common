
# ---------------------------------------------------------------------------
# Cleanup â€” always kill both agents on exit
# ---------------------------------------------------------------------------
cleanup() {
    local exit_code=$?
    [[ -n "$AGENT1_PID" ]] && kill "$AGENT1_PID" 2>/dev/null || true
    [[ -n "$AGENT2_PID" ]] && kill "$AGENT2_PID" 2>/dev/null || true
    rm -f "$CERT_FILE" "$CERT_SRC"
    exit $exit_code
}

TARGET_DIR="$(cargo metadata --no-deps --format-version 1 \
    | python3 -c 'import sys,json; print(json.load(sys.stdin)["target_directory"])')"

# ---------------------------------------------------------------------------
# Helper: start both agents at a given BW cap
# ---------------------------------------------------------------------------
start_agents() {
    # ---
    local cap_mbps="$1"
    local concurrent_streams=${2:-}

    if [[ -n "$concurrent_streams" ]]; then
        concurrent_streams_args="--max-concurrent $concurrent_streams"
    else
        concurrent_streams_args=""
    fi

    echo  "start_agents concurrent_streams:$concurrent_streams"

    echo ""
    echo "==> Starting agents at ${cap_mbps} Mbit/s..."

    rm -f "$CERT_SRC" "$CERT_FILE"

    "$AGENT_BIN" $AGENT_EXTRA_ARGS \
        --bw-cap-mbps "$cap_mbps" \
        --agent-endpoint "$AGENT1_C2I" \
        ${concurrent_streams_args} server \
        --bind "$AGENT1_QUIC" \
        &
    AGENT1_PID=$!

    # Wait for the TLS cert written by the server agent.
    for i in $(seq 1 20); do
        if [[ -f "$CERT_SRC" ]]; then
            cp "$CERT_SRC" "$CERT_FILE"
            break
        fi
        sleep 0.25
        if [[ $i -eq 20 ]]; then
            echo "ERROR: server cert not written after 5s." >&2
            exit 1
        fi
    done

    "$AGENT_BIN" $AGENT_EXTRA_ARGS \
        --bw-cap-mbps "$cap_mbps" \
        --agent-endpoint "$AGENT2_C2I" \
        ${concurrent_streams_args} client \
        --peer "$AGENT1_QUIC" \
        --cert "$CERT_FILE" \
        &
    AGENT2_PID=$!

    # Wait for both C2I ports to be reachable.
    for i in $(seq 1 40); do
        if nc -z 127.0.0.1 9090 2>/dev/null && nc -z 127.0.0.1 9091 2>/dev/null; then
            echo "==> Agents ready after ~$((i * 250))ms"
            break
        fi
        sleep 0.25
        if [[ $i -eq 40 ]]; then
            echo "ERROR: agents not reachable after 10s." >&2
            exit 1
        fi
    done
}
AGENT_EXTRA_ARGS=

# ---------------------------------------------------------------------------
# Helper: stop both agents cleanly
# ---------------------------------------------------------------------------
stop_agents() {
    echo "==> Stopping agents..."
    [[ -n "$AGENT1_PID" ]] && kill "$AGENT1_PID" 2>/dev/null || true
    [[ -n "$AGENT2_PID" ]] && kill "$AGENT2_PID" 2>/dev/null || true
    AGENT1_PID=""
    AGENT2_PID=""
    sleep 0.5
}
